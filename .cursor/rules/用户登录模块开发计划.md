# 用户登录模块开发计划

## 项目概述
实现基于Google OAuth 2.0的用户登录注册系统，包含用户信息管理、JWT会话管理和基础安全防护功能。

## 开发阶段划分

### 第一阶段：基础环境搭建（预计1-2天）
**目标**: 搭建项目基础架构和开发环境

#### 任务1.1：项目依赖安装
- [ ] 安装核心依赖包
  - `express` - Web框架
  - `typescript` - TypeScript支持
  - `dotenv` - 环境变量管理
  - `cors` - 跨域支持
  - `helmet` - 安全中间件
- [ ] 安装认证相关依赖
  - `jsonwebtoken` - JWT令牌处理
  - `passport` - 认证中间件
  - `passport-google-oauth20` - Google OAuth策略
  - `google-auth-library` - Google认证库
- [ ] 安装数据库相关依赖
  - `sqlite3` - SQLite数据库
  - `better-sqlite3` - 更好的SQLite驱动
- [ ] 安装验证和工具依赖
  - `joi` - 数据验证
  - `express-rate-limit` - 频率限制
  - `validator` - 邮箱验证
  - `uuid` - UUID生成

#### 任务1.2：环境配置
- [ ] 创建`.env.example`文件
- [ ] 配置Google OAuth环境变量
- [ ] 设置JWT密钥
- [ ] 配置数据库路径
- [ ] 设置服务器端口和域名

#### 任务1.3：项目结构初始化
- [ ] 创建基础目录结构
- [ ] 初始化TypeScript配置
- [ ] 设置ESLint和Prettier
- [ ] 创建基础的index.ts文件

### 第二阶段：数据库设计与实现（预计1天）
**目标**: 创建数据库表结构和基础数据访问层

#### 任务2.1：数据库初始化
- [ ] 创建SQLite数据库文件
- [ ] 编写数据库初始化脚本
- [ ] 创建用户表(users)
- [ ] 创建用户令牌表(user_tokens)
- [ ] 创建登录记录表(login_logs)
- [ ] 创建必要的索引

#### 任务2.2：数据模型实现
- [ ] 创建`src/models/database.ts` - 数据库连接
- [ ] 创建`src/models/user.model.ts` - 用户数据模型
- [ ] 创建`src/models/token.model.ts` - 令牌数据模型
- [ ] 创建`src/models/log.model.ts` - 日志数据模型
- [ ] 实现基础CRUD操作

#### 任务2.3：数据库工具
- [ ] 创建数据库迁移脚本
- [ ] 创建数据库备份脚本
- [ ] 编写数据库重置脚本

### 第三阶段：类型定义和工具函数（预计0.5天）
**目标**: 定义TypeScript类型和通用工具函数

#### 任务3.1：类型定义
- [ ] 创建`src/types/user.types.ts` - 用户相关类型
- [ ] 创建`src/types/auth.types.ts` - 认证相关类型
- [ ] 创建`src/types/api.types.ts` - API响应类型
- [ ] 创建`src/types/common.types.ts` - 通用类型

#### 任务3.2：工具函数
- [ ] 创建`src/utils/jwt.util.ts` - JWT工具函数
- [ ] 创建`src/utils/validation.util.ts` - 验证工具函数
- [ ] 创建`src/utils/response.util.ts` - 响应格式化工具
- [ ] 创建`src/utils/logger.util.ts` - 日志工具

### 第四阶段：Google OAuth配置（预计1天）
**目标**: 配置Google OAuth 2.0认证

#### 任务4.1：Google Cloud Console配置
- [ ] 创建Google Cloud项目
- [ ] 启用Google+ API
- [ ] 创建OAuth 2.0客户端ID
- [ ] 配置重定向URI
- [ ] 获取客户端密钥

#### 任务4.2：OAuth配置文件
- [ ] 创建`src/config/google.config.ts` - Google OAuth配置
- [ ] 创建`src/config/auth.config.ts` - 认证配置
- [ ] 创建`src/config/app.config.ts` - 应用配置

#### 任务4.3：Passport策略配置
- [ ] 配置Google OAuth策略
- [ ] 设置序列化和反序列化
- [ ] 配置会话管理

### 第五阶段：认证服务实现（预计1-2天）
**目标**: 实现核心认证业务逻辑

#### 任务5.1：认证服务
- [ ] 创建`src/services/auth.service.ts`
- [ ] 实现Google OAuth登录逻辑
- [ ] 实现用户注册逻辑
- [ ] 实现JWT令牌生成和验证
- [ ] 实现令牌刷新逻辑

#### 任务5.2：用户服务
- [ ] 创建`src/services/user.service.ts`
- [ ] 实现用户信息获取
- [ ] 实现用户信息更新
- [ ] 实现用户状态管理

#### 任务5.3：日志服务
- [ ] 创建`src/services/log.service.ts`
- [ ] 实现登录日志记录
- [ ] 实现日志查询功能

### 第六阶段：中间件实现（预计1天）
**目标**: 实现认证和安全相关中间件

#### 任务6.1：认证中间件
- [ ] 创建`src/middleware/auth.middleware.ts`
- [ ] 实现JWT验证中间件
- [ ] 实现用户身份验证
- [ ] 实现权限检查中间件

#### 任务6.2：安全中间件
- [ ] 创建`src/middleware/security.middleware.ts`
- [ ] 实现频率限制中间件
- [ ] 实现CORS配置
- [ ] 实现请求日志中间件

#### 任务6.3：验证中间件
- [ ] 创建`src/middleware/validation.middleware.ts`
- [ ] 实现请求参数验证
- [ ] 实现数据格式验证

### 第七阶段：控制器实现（预计1天）
**目标**: 实现API控制器层

#### 任务7.1：认证控制器
- [ ] 创建`src/controllers/auth.controller.ts`
- [ ] 实现Google OAuth登录接口
- [ ] 实现OAuth回调处理
- [ ] 实现用户登出接口
- [ ] 实现令牌刷新接口

#### 任务7.2：用户控制器
- [ ] 创建`src/controllers/user.controller.ts`
- [ ] 实现用户信息获取接口
- [ ] 实现用户信息更新接口
- [ ] 实现用户状态管理接口

### 第八阶段：路由配置（预计0.5天）
**目标**: 配置API路由

#### 任务8.1：路由定义
- [ ] 创建`src/routes/v1/auth.routes.ts`
- [ ] 创建`src/routes/v1/user.routes.ts`
- [ ] 创建`src/routes/v1/index.ts`
- [ ] 创建`src/routes/index.ts`

#### 任务8.2：路由集成
- [ ] 集成认证路由
- [ ] 集成用户路由
- [ ] 配置路由中间件
- [ ] 设置错误处理

### 第九阶段：应用主文件（预计0.5天）
**目标**: 完成应用主文件和启动配置

#### 任务9.1：主应用文件
- [ ] 完善`src/index.ts`
- [ ] 配置Express应用
- [ ] 集成所有中间件
- [ ] 配置路由
- [ ] 配置错误处理

#### 任务9.2：启动脚本
- [ ] 创建开发启动脚本
- [ ] 创建生产启动脚本
- [ ] 配置热重载

### 第十阶段：测试实现（预计1-2天）
**目标**: 编写单元测试和集成测试

#### 任务10.1：测试环境搭建
- [ ] 安装测试依赖（Jest、Supertest）
- [ ] 配置测试环境
- [ ] 创建测试数据库

#### 任务10.2：单元测试
- [ ] 测试用户服务
- [ ] 测试认证服务
- [ ] 测试工具函数
- [ ] 测试数据模型

#### 任务10.3：集成测试
- [ ] 测试Google OAuth流程
- [ ] 测试API接口
- [ ] 测试中间件功能
- [ ] 测试错误处理

### 第十一阶段：部署和优化（预计1天）
**目标**: 部署应用并进行性能优化

#### 任务11.1：部署准备
- [ ] 创建生产环境配置
- [ ] 编写Dockerfile
- [ ] 配置环境变量
- [ ] 准备部署脚本

#### 任务11.2：性能优化
- [ ] 数据库查询优化
- [ ] 缓存策略实现
- [ ] 错误监控集成
- [ ] 日志记录优化

## 技术实现细节

### 核心技术栈
```typescript
// 主要依赖
{
  "express": "^4.18.0",
  "typescript": "^5.0.0",
  "jsonwebtoken": "^9.0.0",
  "passport": "^0.6.0",
  "passport-google-oauth20": "^2.0.0",
  "google-auth-library": "^9.0.0",
  "better-sqlite3": "^8.0.0",
  "joi": "^17.0.0",
  "express-rate-limit": "^6.0.0"
}
```

### 环境变量配置
```bash
# .env.example
PORT=3000
NODE_ENV=development
DATABASE_URL=./data/app.db

# Google OAuth
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
GOOGLE_CALLBACK_URL=http://localhost:3000/api/v1/auth/google/callback

# JWT
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRES_IN=7d
JWT_REFRESH_EXPIRES_IN=30d

# Security
CORS_ORIGIN=http://localhost:3000
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100
```

### 数据库初始化脚本
```sql
-- 在database.ts中执行
PRAGMA foreign_keys = ON;
PRAGMA journal_mode = WAL;
PRAGMA synchronous = NORMAL;
PRAGMA temp_store = MEMORY;
PRAGMA mmap_size = 268435456;
```

## 测试计划

### 测试类型
1. **单元测试**: 测试独立的函数和模块
2. **集成测试**: 测试API接口和业务流程
3. **安全测试**: 测试认证和授权功能
4. **性能测试**: 测试并发和响应时间

### 测试覆盖率目标
- **代码覆盖率**: ≥80%
- **分支覆盖率**: ≥70%
- **函数覆盖率**: ≥90%

## 风险评估

### 技术风险
- **Google OAuth配置**: 可能需要多次调试
- **JWT安全**: 需要正确配置密钥和过期时间
- **SQLite性能**: 大量并发可能影响性能

### 解决方案
- **充分测试**: 在多个环境中测试OAuth流程
- **安全检查**: 使用安全工具检查JWT配置
- **性能监控**: 监控数据库查询性能

## 部署计划

### 部署环境
1. **开发环境**: 本地开发和测试
2. **测试环境**: 功能测试和集成测试
3. **生产环境**: 正式部署

### 部署步骤
1. 构建Docker镜像
2. 配置环境变量
3. 部署到服务器
4. 配置HTTPS
5. 监控和日志配置

## 时间估计

### 总体时间：7-10个工作日

- **第一阶段**: 1-2天（环境搭建）
- **第二阶段**: 1天（数据库）
- **第三阶段**: 0.5天（类型和工具）
- **第四阶段**: 1天（Google OAuth）
- **第五阶段**: 1-2天（认证服务）
- **第六阶段**: 1天（中间件）
- **第七阶段**: 1天（控制器）
- **第八阶段**: 0.5天（路由）
- **第九阶段**: 0.5天（主应用）
- **第十阶段**: 1-2天（测试）
- **第十一阶段**: 1天（部署优化）

## 验收标准

### 功能验收
- [ ] 用户可以通过Google账号登录
- [ ] 首次登录自动创建用户账号
- [ ] 用户可以查看和更新个人信息
- [ ] 用户可以安全登出
- [ ] JWT令牌可以正常刷新

### 性能验收
- [ ] 登录响应时间 < 2秒
- [ ] API响应时间 < 500ms
- [ ] 支持100并发用户
- [ ] 数据库查询优化

### 安全验收
- [ ] JWT令牌安全性
- [ ] API频率限制
- [ ] 输入数据验证
- [ ] HTTPS强制使用

这个开发计划提供了详细的分步实现指导，可以确保项目的顺利进行和高质量交付。 
# 用户登录模块开发计划

## 项目概述

实现基于 Google OAuth 2.0 的用户登录注册系统，包含用户信息管理、JWT 会话管理和基础安全防护功能。

## 技术栈更新 ✅

### 核心技术栈

- **后端框架**: Node.js + Express + TypeScript
- **数据库**: Supabase (PostgreSQL) 云数据库
- **认证**: Google OAuth 2.0 + JWT Token
- **文件存储**: Cloudflare R2
- **部署**: Railway/Render
- **包管理**: pnpm

### 主要依赖包

```json
{
  "express": "^4.18.2",
  "typescript": "^5.2.2",
  "jsonwebtoken": "^9.0.2",
  "passport": "^0.7.0",
  "passport-google-oauth20": "^2.0.0",
  "google-auth-library": "^10.1.0",
  "@supabase/supabase-js": "^2.50.3",
  "joi": "^17.11.0",
  "express-rate-limit": "^7.1.5",
  "helmet": "^7.1.0",
  "cors": "^2.8.5",
  "dotenv": "^16.3.1",
  "winston": "^3.11.0"
}
```

## 开发阶段划分

### 第一阶段：基础环境搭建 ✅ 已完成

**目标**: 搭建项目基础架构和开发环境

#### 已完成任务

- [x] 项目依赖安装和配置
- [x] TypeScript 配置和项目结构
- [x] 环境变量配置
- [x] 基础中间件配置（helmet, cors, compression 等）
- [x] 日志系统配置
- [x] 错误处理中间件

### 第二阶段：数据库设计与实现 ✅ 已完成

**目标**: 创建数据库表结构和基础数据访问层

#### 已完成任务

- [x] **数据库技术选型**: 选择 Supabase 云数据库
- [x] **移除 SQLite 依赖**: 完全移除 better-sqlite3 和 sqlite3
- [x] **数据库表结构设计**:
  - 用户表（users）
  - 用户令牌表（user_tokens）
  - 登录日志表（login_logs）
- [x] **数据库索引和约束**: 12 个索引，完整约束
- [x] **行级安全策略**: RLS 策略配置
- [x] **数据访问层**: 完整的模型和类型定义
- [x] **初始化脚本**: 数据库部署脚本
- [x] **错误处理**: 连接管理和错误处理
- [x] **监控功能**: 统计和清理功能

### 第三阶段：类型定义和工具函数 🔄 进行中

**目标**: 完善类型定义和通用工具函数

#### 已完成任务

- [x] 基础类型定义（common.types.ts, user.types.ts, database.types.ts）
- [x] 响应格式化工具（response.util.ts）
- [x] 日志工具（logger.util.ts）

#### 待完成任务

- [ ] 完善认证相关类型定义
- [ ] 加密工具函数
- [ ] 验证工具函数
- [ ] 日期处理工具
- [ ] 文件处理工具

### 第四阶段：Google OAuth 配置 ⏳ 待开始

**目标**: 配置 Google OAuth 2.0 认证

#### 待完成任务

- [ ] **Google Cloud Console 配置**

  - [ ] 创建 Google Cloud 项目
  - [ ] 启用 Google+ API
  - [ ] 创建 OAuth 2.0 客户端 ID
  - [ ] 配置重定向 URI
  - [ ] 获取客户端密钥

- [ ] **OAuth 配置文件**

  - [ ] 创建 `src/config/google.config.ts`
  - [ ] 更新 `src/config/auth.config.ts`
  - [ ] 完善 `src/config/app.config.ts`

- [ ] **Passport 策略配置**
  - [ ] 配置 Google OAuth 策略
  - [ ] 设置序列化和反序列化
  - [ ] 配置会话管理

### 第五阶段：认证服务实现 ⏳ 待开始

**目标**: 实现核心认证业务逻辑

#### 待完成任务

- [ ] **认证服务**

  - [ ] 创建 `src/services/auth.service.ts`
  - [ ] 实现 Google OAuth 登录逻辑
  - [ ] 实现用户注册逻辑
  - [ ] 实现 JWT 令牌生成和验证
  - [ ] 实现令牌刷新逻辑

- [ ] **用户服务**

  - [ ] 创建 `src/services/user.service.ts`
  - [ ] 实现用户信息获取
  - [ ] 实现用户信息更新
  - [ ] 实现用户状态管理

- [ ] **日志服务**
  - [ ] 创建 `src/services/log.service.ts`
  - [ ] 实现登录日志记录
  - [ ] 实现日志查询功能

### 第六阶段：中间件实现 ⏳ 待开始

**目标**: 实现认证和安全相关中间件

#### 部分完成任务

- [x] 错误处理中间件（error.middleware.ts）
- [x] 日志中间件（logger.middleware.ts）

#### 待完成任务

- [ ] **认证中间件**

  - [ ] 创建 `src/middleware/auth.middleware.ts`
  - [ ] 实现 JWT 验证中间件
  - [ ] 实现用户身份验证
  - [ ] 实现权限检查中间件

- [ ] **验证中间件**
  - [ ] 创建 `src/middleware/validation.middleware.ts`
  - [ ] 实现请求参数验证
  - [ ] 实现数据格式验证

### 第七阶段：控制器实现 ⏳ 待开始

**目标**: 实现 API 控制器层

#### 待完成任务

- [ ] **认证控制器**

  - [ ] 创建 `src/controllers/auth.controller.ts`
  - [ ] 实现 Google OAuth 登录接口
  - [ ] 实现 OAuth 回调处理
  - [ ] 实现用户登出接口
  - [ ] 实现令牌刷新接口

- [ ] **用户控制器**
  - [ ] 创建 `src/controllers/user.controller.ts`
  - [ ] 实现用户信息获取接口
  - [ ] 实现用户信息更新接口
  - [ ] 实现用户状态管理接口

### 第八阶段：路由配置 ⏳ 待开始

**目标**: 配置 API 路由

#### 部分完成任务

- [x] 基础路由结构（routes/index.ts, routes/v1/index.ts）

#### 待完成任务

- [ ] **路由定义**

  - [ ] 创建 `src/routes/v1/auth.routes.ts`
  - [ ] 创建 `src/routes/v1/user.routes.ts`
  - [ ] 完善路由聚合

- [ ] **路由集成**
  - [ ] 集成认证路由
  - [ ] 集成用户路由
  - [ ] 配置路由中间件
  - [ ] 设置错误处理

### 第九阶段：应用主文件 ⏳ 待开始

**目标**: 完成应用主文件和启动配置

#### 部分完成任务

- [x] 基础应用结构（src/index.ts）
- [x] 中间件集成
- [x] 数据库连接

#### 待完成任务

- [ ] **主应用文件完善**

  - [ ] 完善 Express 应用配置
  - [ ] 集成认证中间件
  - [ ] 配置完整路由
  - [ ] 优化错误处理

- [ ] **启动脚本**
  - [x] 开发启动脚本
  - [x] 生产启动脚本
  - [x] 热重载配置

### 第十阶段：测试实现 ⏳ 待开始

**目标**: 编写单元测试和集成测试

#### 待完成任务

- [ ] **测试环境搭建**

  - [ ] 安装测试依赖（Jest、Supertest）
  - [ ] 配置测试环境
  - [ ] 创建测试数据库

- [ ] **单元测试**

  - [ ] 测试用户服务
  - [ ] 测试认证服务
  - [ ] 测试工具函数
  - [ ] 测试数据模型

- [ ] **集成测试**
  - [ ] 测试 Google OAuth 流程
  - [ ] 测试 API 接口
  - [ ] 测试中间件功能
  - [ ] 测试错误处理

### 第十一阶段：部署和优化 ⏳ 待开始

**目标**: 部署应用并进行性能优化

#### 部分完成任务

- [x] Docker 配置（docker-compose.yml）
- [x] 环境变量配置

#### 待完成任务

- [ ] **部署准备**

  - [ ] 创建生产环境配置
  - [ ] 编写 Dockerfile
  - [ ] 准备部署脚本

- [ ] **性能优化**
  - [ ] 数据库查询优化
  - [ ] 缓存策略实现
  - [ ] 错误监控集成
  - [ ] 日志记录优化

## 当前开发进度总结

### ✅ 已完成（约 30%）

1. **基础环境搭建**: 完全完成
2. **数据库设计与实现**: 完全完成
3. **项目结构**: 基本完成
4. **配置管理**: 基本完成
5. **基础中间件**: 部分完成

### 🔄 进行中（约 10%）

1. **类型定义和工具函数**: 部分完成

### ⏳ 待开始（约 60%）

1. **Google OAuth 配置**: 未开始
2. **认证服务实现**: 未开始
3. **中间件实现**: 部分完成
4. **控制器实现**: 未开始
5. **路由配置**: 部分完成
6. **应用主文件**: 部分完成
7. **测试实现**: 未开始
8. **部署和优化**: 部分完成

## 重要更新说明

### 🔄 技术栈变更

- **移除**: SQLite (better-sqlite3, sqlite3)
- **采用**: Supabase (PostgreSQL) 云数据库
- **优势**:
  - 无需本地数据库安装
  - 自动备份和扩展
  - 内置行级安全策略
  - 实时功能支持

### 📋 环境变量配置

```bash
# 新增 Supabase 配置
SUPABASE_URL=your_supabase_project_url
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_supabase_service_role_key

# 移除 SQLite 配置
# DATABASE_URL=./data/app.db (已移除)
```

### 🗂️ 文件结构更新

```
scripts/
├── create_database_tables.sql  # PostgreSQL 建表脚本
├── init-database.ts           # 数据库初始化脚本
docs/
├── DATABASE_SETUP.md          # 数据库设置指南
├── ENVIRONMENT_SETUP.md       # 环境配置指南
```

### 📦 依赖包更新

```bash
# 移除的包
- better-sqlite3
- sqlite3
- @types/better-sqlite3

# 新增的包
+ @supabase/supabase-js
```

## 下一步计划

### 🎯 近期目标（1-2 天）

1. **完成第三阶段**: 类型定义和工具函数
2. **开始第四阶段**: Google OAuth 配置
3. **配置 Google Cloud Console**
4. **实现基础认证服务**

### 🚀 中期目标（3-5 天）

1. **完成认证服务实现**
2. **完成中间件实现**
3. **完成控制器和路由**
4. **实现完整的登录流程**

### 🏁 最终目标（6-7 天）

1. **完成测试实现**
2. **完成部署配置**
3. **性能优化**
4. **文档完善**

## 验收标准

### 功能验收

- [ ] 用户可以通过 Google 账号登录
- [ ] 首次登录自动创建用户账号
- [ ] 用户可以查看和更新个人信息
- [ ] 用户可以安全登出
- [ ] JWT 令牌可以正常刷新

### 技术验收

- [ ] 使用 Supabase 云数据库
- [ ] 完整的 TypeScript 类型定义
- [ ] 完善的错误处理机制
- [ ] 结构化日志记录
- [ ] API 安全防护

### 性能验收

- [ ] 登录响应时间 < 2 秒
- [ ] API 响应时间 < 500ms
- [ ] 支持 100 并发用户
- [ ] 数据库查询优化

这个更新的开发计划反映了当前的技术栈和开发进度，为后续开发提供了清晰的路线图。
